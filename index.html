<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Experience Tracking</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    video {
      width: 100%;
      max-width: 600px;
      height: auto;
      margin-top: 20px;
      display: none;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      margin: 10px;
    }
    #buttonContainer {
      margin: 20px 0;
    }
    #popup, #cameraPermissionPopup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      border: 2px solid #4CAF50;
      padding: 20px;
      z-index: 1000;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
  </style>
</head>
<body>

  <h1>User Experience Tracking</h1>

  <div id="buttonContainer">
    <button id="watchBtn" style="display: none;">Step 2: Watch Video</button>
  </div>

  <div id="videoContainer">
    <video id="videoPlayer" preload="auto">
      <source src="https://x-ad-assets.s3.amazonaws.com/media_asset/e3ff10b4f14faa07/media" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <div id="overlay"></div>

  <!-- Popup for Camera Permission -->
  <div id="cameraPermissionPopup">
    <h2>Step 1: Allow Camera Access</h2>
    <p>This experience requires access to your camera to track your emotions while watching the video.</p>
    <p><a href="https://yaronskihoma.github.io/VideoTask2/privacypolicy.html" target="_blank">Read our Privacy Policy</a></p>
    <button id="allowCameraBtn">Allow Camera</button>
  </div>

  <!-- Supabase Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://sdk.morphcast.com/mphtools/v1.1/mphtools.js" data-config="cameraPrivacyPopup, compatibilityUI, compatibilityAutoCheck"></script>
  <script src="https://ai-sdk.morphcast.com/v1.16/ai-sdk.js"></script>
  <script src="https://sdk.morphcast.com/emotion-statistics/v1.0-beta/script.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

  <script>
    // Initialize Supabase Client
    const supabase = supabase.createClient(
      'https://szshayacurojnsbdcwkc.supabase.co', // Replace with your Supabase URL
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6c2hheWFjdXJvam5zYmRjd2tjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE4NTg0NTYsImV4cCI6MjA0NzQzNDQ1Nn0.02eSqWEjA3VKA6sBGtnjq44ljQ-DSUsanh8EZWfFrcE' // Replace with your Supabase Anon Key
    );

    let trackingData = [];
    let morphcastInstance = null;
    const watchBtn = document.getElementById('watchBtn');
    const videoPlayer = document.getElementById('videoPlayer');
    const cameraPermissionPopup = document.getElementById('cameraPermissionPopup');
    const allowCameraBtn = document.getElementById('allowCameraBtn');

    // Function to upload reports to Supabase
    async function uploadReportToSupabase(zipBlob) {
      try {
        const fileName = `report_${Date.now()}.zip`;
        const { data, error } = await supabase.storage
          .from('AROSUALDATA') // Supabase Storage bucket name
          .upload(fileName, zipBlob, {
            contentType: 'application/zip',
          });

        if (error) {
          console.error('Upload failed:', error.message);
          alert('Failed to upload the report. Please try again.');
        } else {
          console.log('File uploaded successfully:', data);
          alert('Report uploaded successfully!');
        }
      } catch (err) {
        console.error('Unexpected error:', err);
        alert('An unexpected error occurred while uploading the report.');
      }
    }

    // Function to generate and upload ZIP report
    async function generateAndUploadZipReport() {
      const zip = new JSZip();

      // Convert tracking data to JSON and CSV
      const deviceDetails = getDeviceDetails();
      const jsonData = JSON.stringify({ trackingData, deviceDetails }, null, 2);
      const csvData = convertToCSV(trackingData);

      // Add JSON and CSV to ZIP
      zip.file(`report_${Date.now()}.json`, jsonData);
      zip.file(`report_${Date.now()}.csv`, csvData);

      // Generate ZIP blob
      const zipBlob = await zip.generateAsync({ type: 'blob' });

      // Upload ZIP to Supabase
      await uploadReportToSupabase(zipBlob);
    }

    // Event listener for video end
    videoPlayer.onended = async () => {
      if (morphcastInstance) {
        await morphcastInstance.stop();
      }

      // Generate and upload the ZIP report
      await generateAndUploadZipReport();
    };

    // Utility Functions
    function convertToCSV(data) {
      const headers = ['mediaTime', 'type', 'attention', 'dominantEmotion', 'arousal', 'valence', 'emotions', 'totalFaces', 'status', 'alarmTriggered', 'aggregatedData'];
      const csvRows = [headers.join(',')];

      data.forEach(row => {
        csvRows.push([
          row.mediaTime, row.type, row.attention || '', row.dominantEmotion || '', row.arousal || '', row.valence || '',
          JSON.stringify(row.emotions || ''), row.totalFaces || '', row.status || '', row.alarmTriggered || '', JSON.stringify(row.aggregatedData || '')
        ].join(','));
      });

      return csvRows.join('\n');
    }

    function getDeviceDetails() {
      return {
        browser: navigator.userAgent,
        platform: navigator.platform,
        date: new Date().toISOString(),
      };
    }

    function requestCameraAccess() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(() => {
          cameraPermissionPopup.style.display = 'none';
          watchBtn.style.display = 'inline-block';
        })
        .catch(() => {
          alert('Camera access denied.');
        });
    }

    allowCameraBtn.addEventListener('click', requestCameraAccess);

    CY.loader()
      .licenseKey("your-license-key")
      .addModule(CY.modules().FACE_AROUSAL_VALENCE.name)
      .load()
      .then(({ start, stop }) => {
        morphcastInstance = { start, stop };
      });
  </script>
</body>
</html>
